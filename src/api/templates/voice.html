<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Robot Voice Interface</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/favicon/site.webmanifest">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --background-color: #1a1a1a;
            --surface-color: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --hover-color: #2980b9;
            --success-color: #4CAF50;
            --error-color: #ff6b6b;
            --muted-text: #a0a0a0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
                Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-color);
            background-image: url('/static/images/backgrounds/bg-desk-dust-1.jpg');
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            flex-shrink: 0;
            width: 100%;
            padding: 1rem 2rem;
            background: var(--surface-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 100;
        }

        .header-logo {
            height: 40px;
            object-fit: contain;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pet-video {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.3s ease;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .pet-video:hover {
            transform: scale(1.1);
        }

        .temp-brain-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .brain-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .header-text {
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        .container {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 2rem;
            padding: 2rem;
            background: rgba(26, 26, 26, 0.75);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
            transition: grid-template-columns 0.3s ease;
            height: calc(100vh - 5rem); /* Fixed height based on viewport */
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .container.settings-collapsed {
            grid-template-columns: 60px 1fr 300px;
        }

        .container.logs-collapsed {
            grid-template-columns: 300px 1fr 60px;
        }

        .container.main-collapsed {
            grid-template-columns: 300px 60px 300px;
        }

        .container.settings-collapsed.logs-collapsed {
            grid-template-columns: 60px 1fr 60px;
        }

        .container.settings-collapsed.main-collapsed {
            grid-template-columns: 60px 60px 300px;
        }

        .container.logs-collapsed.main-collapsed {
            grid-template-columns: 300px 60px 60px;
        }

        .container.settings-collapsed.main-collapsed.logs-collapsed {
            grid-template-columns: 60px 60px 60px;
        }

        .column-toggle {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 32px;
            height: 32px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .column-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-color);
        }

        .column-toggle svg {
            width: 16px;
            height: 16px;
            color: var(--text-color);
            transition: transform 0.3s ease;
        }

        .column-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            padding-top: 4rem; /* Make room for the toggle button */
            overflow: hidden;
        }

        .settings-column.collapsed,
        .main-column.collapsed,
        .logs-column.collapsed {
            padding: 0;
            width: 60px;
        }

        .collapsed .column-content {
            opacity: 0;
            pointer-events: none;
        }

        .collapsed .column-toggle svg {
            transform: rotate(180deg);
        }

        .collapsed-icon {
            display: none;
            width: 30px;
            height: 30px;
            margin: 0 auto;
            margin-top: 4rem;
        }

        .collapsed .collapsed-icon {
            display: block;
        }

        .settings {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: min-content;
            padding-bottom: 1rem; /* Add padding at bottom */
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-group label {
            display: block;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .setting-group input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
        }

        .setting-description {
            font-size: 0.875rem;
            color: var(--muted-text);
            line-height: 1.4;
            margin-top: 0.25rem;
        }

        .setting-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--surface-color);
            color: var(--text-color);
            margin-top: 0.25rem;
        }

        .calibration-section {
            position: sticky;
            bottom: 0;
            background: rgba(32, 32, 32, 0.95);
            padding: 1rem 0;
            z-index: 2;
            width: 100%;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .calibration-section h4 {
            color: var(--text-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .calibration-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .calibration-status {
            background: var(--surface-color);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .calibration-progress {
            height: 4px;
            background: var(--background-color);
            border-radius: 2px;
            margin: 0.75rem 0;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--primary-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .samples-count {
            font-size: 0.875rem;
            color: var(--muted-text);
            margin-top: 0.5rem;
        }

        .logs-column {
            position: relative;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            width: 300px;
            background: rgba(32, 32, 32, 0.95);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: calc(100vh - 8rem); /* Fixed height relative to viewport */
            overflow: hidden;
        }

        .logs-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 1rem;
            min-height: min-content;
        }

        .header-controls {
            flex: 0 0 auto;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            width: 100%;
            background: rgba(45, 45, 45, 0.9);
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-search {
            flex: 1;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .clear-button, .copy-button {
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-button:hover, .copy-button:hover {
            background: rgba(45, 45, 45, 0.9);
            color: rgba(255, 255, 255, 0.9);
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
            background: rgba(32, 32, 32, 0.95);
            border-radius: 6px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100px;
        }

        .log-entry {
            padding: 0.35rem 0;
            color: rgba(255, 255, 255, 0.9);
            font-family: monospace;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-timestamp {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        .log-source {
            color: rgba(255, 255, 255, 0.7);
            margin-right: 0.5rem;
        }

        .log-level {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .log-level.info {
            background: rgba(66, 153, 225, 0.2);
            color: #63B3ED;
        }

        .log-level.error {
            background: rgba(245, 101, 101, 0.2);
            color: #FC8181;
        }

        .log-level.warning {
            background: rgba(236, 201, 75, 0.2);
            color: #F6E05E;
        }

        .log-level.debug {
            background: rgba(72, 187, 120, 0.2);
            color: #68D391;
        }

        .log-message {
            color: rgba(255, 255, 255, 0.9);
            word-break: break-word;
        }

        .log-controls {
            flex: 0 0 auto;
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.75rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .log-filters {
            display: flex;
            gap: 1rem;
        }

        .log-level-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .log-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
        }

        .search-wrapper {
            flex: 1;
            min-width: 150px;
            padding-right: 1rem;
        }

        .log-controls-right {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            margin-right: 0;
            padding-right: 0;
            position: relative;
            right: 0.75rem;
        }

        .icon-button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 0.35rem;
            margin: 0;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .icon-button:hover {
            color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .icon-button svg {
            width: 16px;
            height: 16px;
        }

        .search-input {
            width: 100%;
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: var(--text-color);
            padding: 0.5rem;
            font-size: 0.85rem;
            height: 36px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .log-filter, .log-level-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
        }

        .log-level-filter {
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .log-level-filter input[type="checkbox"] {
            margin: 0;
        }

        .copy-button {
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .copy-button:hover {
            background: rgba(45, 45, 45, 0.9);
            color: rgba(255, 255, 255, 0.9);
        }

        /* Scrollbar styling */
        .settings::-webkit-scrollbar,
        .voice-interface::-webkit-scrollbar,
        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .settings::-webkit-scrollbar-track,
        .voice-interface::-webkit-scrollbar-track,
        .log-container::-webkit-scrollbar-track {
            background: rgba(26, 26, 26, 0.5);
            border-radius: 4px;
        }

        .settings::-webkit-scrollbar-thumb,
        .voice-interface::-webkit-scrollbar-thumb,
        .log-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .settings::-webkit-scrollbar-thumb:hover,
        .voice-interface::-webkit-scrollbar-thumb:hover,
        .log-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        .voice-interface {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            min-height: min-content;
            padding-bottom: 1rem; /* Add padding at bottom */
        }

        .thought-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
        }

        .logo-container {
            position: relative;
            width: 100%;
            max-width: min(50vh, 50vw);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .logo.listening {
            transform: rotate(7deg);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .shuffle-button {
            position: absolute;
            bottom: 10%;
            right: 10%;
            width: min(40px, 10%);
            height: min(40px, 10%);
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .shuffle-button svg {
            width: 60%;
            height: 60%;
            color: rgba(255, 255, 255, 0.7);
        }

        .shuffle-button:hover {
            transform: scale(1.1);
            background: var(--primary-color);
        }

        /* Add responsive breakpoints */
        @media (max-width: 1200px) {
            .logo-container {
                max-width: min(40vh, 40vw);
            }
        }

        @media (max-width: 768px) {
            .logo-container {
                max-width: min(35vh, 35vw);
            }
        }

        @media (max-width: 480px) {
            .logo-container {
                max-width: min(30vh, 30vw);
            }

            .shuffle-button {
                width: min(32px, 8%);
                height: min(32px, 8%);
            }
        }

        /* Adjust container grid for smaller screens */
        @media (max-width: 1024px) {
            .container {
                gap: 1rem;
            }

            .container.settings-collapsed {
                grid-template-columns: 50px 1fr 300px;
            }

            .container.main-collapsed {
                grid-template-columns: 300px 50px 300px;
            }

            .container.logs-collapsed {
                grid-template-columns: 300px 1fr 50px;
            }

            .settings-column.collapsed,
            .main-column.collapsed,
            .logs-column.collapsed {
                width: 50px;
            }
        }

        /* Adjust for very small screens */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .voice-interface {
                padding: 1rem;
            }
        }

        .mic-visualization {
            position: relative;
            width: 100%;
            max-width: 200px;
            margin: 2rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .mic-icon {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(32, 32, 32, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .mic-icon.mic-active {
            border-color: #3498db;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
        }

        .mic-icon svg {
            width: 48px;
            height: 48px;
            fill: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }

        .mic-icon.mic-active svg {
            fill: #3498db;
        }

        .mic-waves {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .wave {
            position: absolute;
            border: 2px solid transparent;
            border-radius: 50%;
            width: 100%;
            height: 100%;
            animation: none;
        }

        .mic-active .wave {
            border-color: rgba(52, 152, 219, 0.2);
            animation: wave 2s infinite;
        }

        .mic-active .wave:nth-child(2) {
            animation-delay: 0.3s;
        }

        .mic-active .wave:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes wave {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .volume-meter {
            width: 100%;
            max-width: 300px;
            height: 4px;
            background: rgba(32, 32, 32, 0.95);
            border-radius: 2px;
            margin: 1rem auto;
            overflow: hidden;
            position: relative;
        }

        .volume-level {
            height: 100%;
            width: 0%;
            background: #3498db;
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .volume-meter.active {
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        /* Common styles for all columns */
        .settings-column,
        .main-column,
        .logs-column {
            position: relative;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            background: rgba(32, 32, 32, 0.95);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 100%; /* Take full height of container */
            overflow: hidden; /* Hide overflow at column level */
        }

        .column-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 1rem;
            overflow-y: auto; /* Enable scrolling at content level */
            padding-right: 0.5rem;
        }

        /* Settings specific styles */
        .settings {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: min-content;
            padding-bottom: 1rem; /* Add padding at bottom */
        }

        .setting-group {
            flex: 0 0 auto; /* Don't allow shrinking */
        }

        .calibration-section {
            flex: 0 0 auto; /* Don't allow shrinking */
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Voice interface specific styles */
        .voice-interface {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            min-height: min-content;
            padding-bottom: 1rem; /* Add padding at bottom */
        }

        .controls {
            position: sticky;
            bottom: 0;
            background: rgba(32, 32, 32, 0.95);
            padding: 1rem 0;
            z-index: 2;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Logs specific styles */
        .logs-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 1rem;
            min-height: min-content;
        }

        .header-controls {
            flex: 0 0 auto;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            width: 100%;
            background: rgba(45, 45, 45, 0.9);
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
            background: rgba(32, 32, 32, 0.95);
            border-radius: 6px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 100px;
        }

        .log-controls {
            flex: 0 0 auto;
            background: rgba(45, 45, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.75rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .log-filters {
            display: flex;
            gap: 1rem;
        }

        .log-level-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .log-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .log-controls-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 120px;
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: var(--text-color);
            padding: 0.5rem;
            font-size: 0.85rem;
            height: 36px;
        }

        /* Button styles */
        .button {
            flex: 0 0 auto; /* Don't allow shrinking */
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .button:hover {
            background: var(--hover-color);
        }

        .button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        /* Ensure buttons and form elements don't shrink */
        .button,
        select,
        input[type="range"] {
            flex-shrink: 0;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .copy-feedback {
            display: none;  /* Remove the old feedback */
        }

        .inspiration-jewel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .inspiration-jewel:hover {
            transform: scale(1.1);
        }

        .inspiration-modal {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: rgba(32, 32, 32, 0.95);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 450px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            color: var(--text-color);
        }

        .data-visualization {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 120px;
            gap: 1rem;
            margin: 1rem 0;
        }

        .bar {
            flex: 1;
            background: var(--primary-color);
            transition: height 0.5s ease;
            position: relative;
            border-radius: 4px 4px 0 0;
            min-width: 60px;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: var(--primary-color);
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .tag {
            background: rgba(52, 152, 219, 0.15);
            color: var(--primary-color);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tag:hover {
            background: var(--primary-color);
            color: white;
        }

        .action-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background: var(--hover-color);
            transform: translateY(-1px);
        }

        .inspiration-modal.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .inspiration-content {
            margin-bottom: 1rem;
        }

        .inspiration-source {
            color: var(--primary-color);
            font-style: italic;
            font-size: 0.9em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="header-brand" style="text-decoration: none;">
            <img src="/static/images/light-mode-brain-2.png" alt="Brain Icon" class="brain-image">
            <span class="header-text">Good Robot</span>
        </a>
        <nav class="nav-links">
            <a href="/docs" class="nav-link">API Docs</a>
            <a href="/voice" class="nav-link">Voice Interface</a>
            <a href="/research" class="nav-link">Research</a>
            <a href="/sample-recorder" class="nav-link">Sample Recorder</a>
        </nav>
    </header>

    <div class="container">
        <div class="settings-column">
            <button class="column-toggle" id="settingsToggle" title="Toggle Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            <div class="collapsed-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </div>
            <div class="column-content">
                <div class="settings">
                    <h3>Voice Settings</h3>

                    <div class="setting-group">
                        <label for="sensitivity">Wake Word Sensitivity:</label>
                        <input type="range" id="sensitivity" min="0" max="1" step="0.1" value="0.5" />
                        <span id="sensitivityValue">0.5</span>
                        <div class="setting-description">Lower values make detection more sensitive (0.1 is most sensitive)</div>
                    </div>

                    <div class="setting-group">
                        <label for="audioGain">Audio Input Gain:</label>
                        <input type="range" id="audioGain" min="0" max="2" step="0.1" value="1.0" />
                        <span id="audioGainValue">1.0</span>
                        <div class="setting-description">Adjust microphone input level</div>
                    </div>

                    <div class="setting-group">
                        <label for="noiseThreshold">Noise Threshold:</label>
                        <input type="range" id="noiseThreshold" min="0" max="1" step="0.05" value="0.15" />
                        <span id="noiseThresholdValue">0.15</span>
                        <div class="setting-description">Minimum volume level to process (reduces background noise)</div>
                    </div>

                    <div class="setting-group">
                        <label for="language">Language:</label>
                        <select id="language">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                        </select>
                    </div>

                    <div class="calibration-section">
                        <h4>Calibration Mode</h4>
                        <div class="calibration-controls">
                            <button id="startCalibration" class="button">Start Calibration</button>
                            <button id="stopCalibration" class="button" style="display: none;">Stop Listening</button>
                        </div>
                        <div class="calibration-status" style="display: none;">
                            <p>Say "jarvis" 5 times to calibrate...</p>
                            <div class="calibration-progress">
                                <div class="progress-bar"></div>
                            </div>
                            <p class="samples-count">Samples: 0/5</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-column">
            <button class="column-toggle" id="mainToggle" title="Toggle Main">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            <div class="collapsed-icon">
                <img src="" alt="Current Avatar" id="collapsedAvatar" style="width: 30px; height: 30px; object-fit: contain;">
            </div>
            <div class="column-content">
                <div class="voice-interface">
                    <div class="thought-container">
                        <div class="logo-container">
                            <img src="/static/images/hipster_1.png" alt="Robot Face" class="logo" id="robotFace">
                            <button class="shuffle-button" id="shuffleButton" title="Switch Robot Face">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21.5 2v6h-6M21.5 22v-6h-6M2.5 12c0-4.4 3.6-8 8-8h8.5M2.5 12c0 4.4 3.6 8 8 8h8.5"/>
                                </svg>
                            </button>
                        </div>
                        <div class="live-transcription" id="liveTranscription">
                            <div class="transcription-label">Hearing:</div>
                            <div class="transcription-text"></div>
                        </div>
                    </div>

                    <div class="status" id="status">Ready to listen</div>

                    <div class="mic-visualization">
                        <div class="mic-icon">
                            <svg viewBox="0 0 24 24">
                                <path class="mic-body" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                            </svg>
                            <div class="mic-waves">
                                <div class="wave"></div>
                                <div class="wave"></div>
                                <div class="wave"></div>
                            </div>
                        </div>
                    </div>

                    <div class="volume-meter">
                        <div class="volume-level" id="volumeLevel"></div>
                    </div>

                    <div class="controls">
                        <button class="button" id="startButton">Start Listening</button>
                        <button class="button" id="stopButton" disabled>Stop Listening</button>
                    </div>

                    <div class="transcription" id="transcription" contenteditable="true" placeholder="Transcription will appear here..."></div>
                    <div class="response" id="response" placeholder="Robot's response will appear here..."></div>
                </div>
            </div>
        </div>

        <div class="logs-column">
            <button class="column-toggle" id="logsToggle" title="Toggle Logs">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            <div class="column-content">
                <div class="logs-content">
                    <div class="log-container" id="logContainer"></div>
                    <div class="log-controls">
                        <div class="log-buttons">
                            <div class="search-wrapper">
                                <input type="text" id="logSearch" placeholder="Search logs..." class="search-input">
                            </div>
                            <div class="log-controls-right">
                                <button class="icon-button" id="copyLogs" title="Copy logs to clipboard">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                                <button class="icon-button" id="clearLogs" title="Clear all logs">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="log-filters">
                            <div class="source-filters">
                                <label class="log-filter">
                                    <input type="checkbox" id="showServerLogs" checked>
                                    Server Logs
                                </label>
                                <label class="log-filter">
                                    <input type="checkbox" id="showClientLogs" checked>
                                    Client Logs
                                </label>
                            </div>
                        </div>
                        <div class="log-level-filters">
                            <label class="log-level-filter">
                                <input type="checkbox" id="showDebug" checked>
                                DEBUG
                            </label>
                            <label class="log-level-filter">
                                <input type="checkbox" id="showInfo" checked>
                                INFO
                            </label>
                            <label class="log-level-filter">
                                <input type="checkbox" id="showWarning" checked>
                                WARNING
                            </label>
                            <label class="log-level-filter">
                                <input type="checkbox" id="showError" checked>
                                ERROR
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="copy-feedback" id="copyFeedback">Copied to clipboard!</div>
    </div>

    <video class="pet-video" id="petVideo" autoplay loop muted playsinline>
        <source src="/static/movies/pet-dog-2-small.mp4" type="video/mp4">
    </video>

    <div class="inspiration-jewel" id="inspirationJewel">
        <img src="https://hive-qlife.firebaseapp.com/images/giffy/crystal_pink.gif" alt="Inspiration Jewel" style="width: 100%; height: 100%; object-fit: contain;">
    </div>

    <div class="inspiration-modal" id="inspirationModal">
        <div class="inspiration-content">
            <h3>Daily Scientific Insight</h3>
            <p id="inspirationText"></p>
            <p class="inspiration-source">Source: <a id="inspirationSource" href="#" target="_blank"></a></p>
        </div>
        <button class="button" id="closeInspiration">Close</button>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const status = document.getElementById('status');
        const transcription = document.getElementById('transcription');
        const response = document.getElementById('response');
        const volumeLevel = document.getElementById('volumeLevel');
        const darkLogo = document.querySelector('.logo.dark');
        const lightLogo = document.querySelector('.logo.light');
        const language = document.getElementById('language');
        const logContainer = document.getElementById('logContainer');
        const sensitivity = document.getElementById('sensitivity');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const audioGain = document.getElementById('audioGain');
        const audioGainValue = document.getElementById('audioGainValue');
        const noiseThreshold = document.getElementById('noiseThreshold');
        const noiseThresholdValue = document.getElementById('noiseThresholdValue');
        const startCalibration = document.getElementById('startCalibration');
        const stopCalibration = document.getElementById('stopCalibration');
        const calibrationStatus = document.querySelector('.calibration-status');
        const progressBar = document.querySelector('.progress-bar');
        const samplesCount = document.querySelector('.samples-count');
        const robotFace = document.getElementById('robotFace');
        const shuffleButton = document.getElementById('shuffleButton');
        const robotFaces = [
            '/static/images/hipster_1.png',
            '/static/images/hipster-female-younger-1-blue.png',
            '/static/images/hipster-female-younger-1-gray.png',
            '/static/images/hipster-female-younger-1.png',
            '/static/images/hipster-male-younger-1.png',
            '/static/images/hipster-male-older-1.png',
            '/static/images/hipster-female-older-1.png',
            '/static/images/hipster-female-2.png',
            '/static/images/hipster-female-1.png',
            '/static/images/hipster-6.png',
            '/static/images/hipster-5.png',
            '/static/images/hipster-4.png',
            '/static/images/hipster-3.png',
            '/static/images/hipster-2.png',
            '/static/images/light-mode-brain-2.png',
            '/static/images/light-mode-logo-3.png'
        ];
        let currentFaceIndex = robotFaces.indexOf('/static/images/hipster-5.png');

        let mediaRecorder;
        let audioStream;
        let isListening = false;
        let ws = null;
        let audioContext;
        let source;
        let analyser;
        let gainNode;
        let calibrationMode = false;
        let calibrationSamples = [];
        let wsReconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 2000; // 2 seconds
        let wsConnected = false;

        const showServerLogs = document.getElementById('showServerLogs');
        const showClientLogs = document.getElementById('showClientLogs');
        const showDebug = document.getElementById('showDebug');
        const showInfo = document.getElementById('showInfo');
        const showWarning = document.getElementById('showWarning');
        const showError = document.getElementById('showError');
        const logSearch = document.getElementById('logSearch');
        let logEntries = [];

        // Settings persistence
        const SETTINGS_KEY = 'voiceInterfaceSettings';
        
        // Default settings
        const DEFAULT_SETTINGS = {
            sensitivity: 0.5,
            audioGain: 1.0,
            noiseThreshold: 0.15,
            language: 'en-US'
        };

        // Load settings from localStorage
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    sensitivity.value = settings.sensitivity;
                    sensitivityValue.textContent = settings.sensitivity;
                    audioGain.value = settings.audioGain;
                    audioGainValue.textContent = settings.audioGain;
                    noiseThreshold.value = settings.noiseThreshold;
                    noiseThresholdValue.textContent = settings.noiseThreshold;
                    language.value = settings.language;
                    
                    // Load saved avatar if it exists
                    const savedAvatar = localStorage.getItem('selectedAvatar');
                    if (savedAvatar) {
                        robotFace.src = savedAvatar;
                        currentFaceIndex = robotFaces.indexOf(savedAvatar);
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            try {
                const settings = {
                    sensitivity: sensitivity.value,
                    audioGain: audioGain.value,
                    noiseThreshold: noiseThreshold.value,
                    language: language.value
                };
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        // Initialize settings
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            // Set initial values from DEFAULT_SETTINGS if no saved settings exist
            sensitivity.value = sensitivity.value || DEFAULT_SETTINGS.sensitivity;
            sensitivityValue.textContent = sensitivity.value;
            
            audioGain.value = audioGain.value || DEFAULT_SETTINGS.audioGain;
            audioGainValue.textContent = audioGain.value;
            
            noiseThreshold.value = noiseThreshold.value || DEFAULT_SETTINGS.noiseThreshold;
            noiseThresholdValue.textContent = noiseThreshold.value;
            
            language.value = language.value || DEFAULT_SETTINGS.language;

            // Add event listeners for settings changes
            sensitivity.addEventListener('input', () => {
                sensitivityValue.textContent = sensitivity.value;
                saveSettings();
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'config',
                        sensitivity: parseFloat(sensitivity.value),
                        noiseThreshold: parseFloat(noiseThreshold.value)
                    }));
                }
            });

            audioGain.addEventListener('input', () => {
                audioGainValue.textContent = audioGain.value;
                if (gainNode) {
                    gainNode.gain.value = parseFloat(audioGain.value);
                }
                saveSettings();
            });

            noiseThreshold.addEventListener('input', () => {
                noiseThresholdValue.textContent = noiseThreshold.value;
                saveSettings();
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'config',
                        sensitivity: parseFloat(sensitivity.value),
                        noiseThreshold: parseFloat(noiseThreshold.value)
                    }));
                }
            });

            language.addEventListener('change', () => {
                saveSettings();
            });
        });

        // Helper function to format timestamps
        function formatTimestamp(timestamp) {
            if (timestamp instanceof Date) {
                return timestamp.toLocaleTimeString();
            }
            return new Date(timestamp).toLocaleTimeString();
        }

        // Load logs from localStorage on page load
        window.addEventListener('load', () => {
            try {
                const savedLogs = localStorage.getItem('voiceLogs');
                if (savedLogs) {
                    const parsed = JSON.parse(savedLogs);
                    logEntries = parsed.map(entry => ({
                        ...entry,
                        timestamp: new Date(entry.timestamp)
                    }));
                    updateLogDisplay();
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                localStorage.removeItem('voiceLogs'); // Clear corrupted data
                logEntries = [];
            }
        });

        // Save logs to localStorage periodically
        setInterval(() => {
            try {
                if (logEntries.length > 0) {
                    localStorage.setItem('voiceLogs', JSON.stringify(logEntries));
                }
            } catch (error) {
                console.error('Error saving logs:', error);
            }
        }, 5000);

        function addLogEntry(message, isError = false, source = 'client', level = 'INFO') {
            try {
                const entry = {
                    timestamp: new Date(),
                    message,
                    isError,
                    source,
                    level
                };

                logEntries.push(entry);
                // Keep only the last 1000 entries to prevent memory issues
                if (logEntries.length > 1000) {
                    logEntries = logEntries.slice(-1000);
                }
                updateLogDisplay();
            } catch (error) {
                console.error('Error adding log entry:', error);
            }
        }

        function updateLogDisplay() {
            try {
                logContainer.innerHTML = '';

                const searchTerm = logSearch.value.toLowerCase();
                const filteredEntries = logEntries.filter(entry => {
                    // Source filter
                    if (entry.source === 'server' && !showServerLogs.checked) return false;
                    if (entry.source === 'client' && !showClientLogs.checked) return false;

                    // Level filter
                    if (entry.level === 'DEBUG' && !showDebug.checked) return false;
                    if (entry.level === 'INFO' && !showInfo.checked) return false;
                    if (entry.level === 'WARNING' && !showWarning.checked) return false;
                    if (entry.level === 'ERROR' && !showError.checked) return false;

                    // Search filter
                    if (searchTerm && !entry.message.toLowerCase().includes(searchTerm)) return false;

                    return true;
                });

                filteredEntries.forEach(entry => {
                    const entryElement = document.createElement('div');
                    entryElement.className = `log-entry ${entry.source} ${entry.level.toLowerCase()}`;

                    const timestamp = document.createElement('span');
                    timestamp.className = 'log-timestamp';
                    timestamp.textContent = formatTimestamp(entry.timestamp);

                    const source = document.createElement('span');
                    source.className = 'log-source';
                    source.textContent = `[${entry.source}]`;

                    const level = document.createElement('span');
                    level.className = `log-level ${entry.level.toLowerCase()}`;
                    level.textContent = entry.level;

                    const messageSpan = document.createElement('span');
                    messageSpan.className = 'log-message';

                    if (searchTerm && entry.message) {
                        const message = entry.message.toString();
                        const index = message.toLowerCase().indexOf(searchTerm);
                        if (index !== -1) {
                            const before = message.substring(0, index);
                            const match = message.substring(index, index + searchTerm.length);
                            const after = message.substring(index + searchTerm.length);
                            messageSpan.innerHTML = `${before}<span class="highlight">${match}</span>${after}`;
                        } else {
                            messageSpan.textContent = message;
                        }
                    } else {
                        messageSpan.textContent = entry.message || '';
                    }

                    entryElement.appendChild(timestamp);
                    entryElement.appendChild(source);
                    entryElement.appendChild(level);
                    entryElement.appendChild(messageSpan);

                    logContainer.appendChild(entryElement);
                });

                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (error) {
                console.error('Error updating log display:', error);
            }
        }

        // Add debounced restart function
        let restartTimeout;
        function debouncedRestart() {
            clearTimeout(restartTimeout);
            restartTimeout = setTimeout(() => {
                if (isListening) {
                    stopListening();
                    setTimeout(() => {
                        startListening();
                    }, 500);
                }
            }, 1000);
        }

        // Helper function to generate a unique client ID
        function generateClientId() {
            return 'client_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function updateUIState(state) {
            isListening = state;
            startButton.style.display = state ? 'none' : 'inline';
            stopButton.style.display = state ? 'inline' : 'none';
            stopButton.disabled = !state;
            startButton.disabled = state;
            status.textContent = state ? 'Listening...' : 'Not listening';
            robotFace.classList.toggle('listening', state);
        }

        async function startListening() {
            try {
                if (isListening) {
                    console.log('Already listening');
                    return;
                }

                // Create audio context first with explicit sample rate
                audioContext = new AudioContext({
                    sampleRate: 48000
                });
                
                // Get audio stream with matching sample rate
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: {
                            ideal: audioContext.sampleRate
                        }
                    }
                });

                // Create and connect nodes
                source = audioContext.createMediaStreamSource(audioStream);
                gainNode = audioContext.createGain();
                gainNode.gain.value = parseFloat(audioGain.value);

                // Create analyzer for visualization
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                analyser.minDecibels = -100;
                analyser.maxDecibels = -30;

                // Add audio worklet with proper sample rate
                await audioContext.audioWorklet.addModule('static/js/audio-processor.js');
                const processorNode = new AudioWorkletNode(audioContext, 'audio-processor', {
                    processorOptions: {
                        inputSampleRate: audioContext.sampleRate,
                        targetSampleRate: 16000,
                        bufferSize: 512
                    }
                });

                // Set up processor message handler
                processorNode.port.onmessage = (event) => {
                    if (event.data.type === 'audio' && ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'audio',
                            data: event.data.data,
                            metrics: event.data.metrics
                        }));
                    }
                };

                // Connect nodes
                source.connect(gainNode);
                gainNode.connect(analyser);
                gainNode.connect(processorNode);
                processorNode.connect(audioContext.destination);

                // Set up WebSocket with retry logic
                await setupWebSocketWithRetry();
                
                // Start visualization
                visualize();

                // Update UI state
                updateUIState(true);
                
                console.log('Audio capture started successfully');
                addLogEntry('Audio capture started', false, 'client', 'INFO');
            } catch (error) {
                console.error('Error starting audio capture:', error);
                addLogEntry(`Error starting audio capture: ${error.message}`, true, 'client', 'ERROR');
                await cleanupAudioResources();
                updateUIState(false);
            }
        }

        async function stopListening() {
            if (!isListening) {
                console.log('Already stopped listening');
                return;
            }

            console.log('Stopping listening...');
            
            try {
                // Send stop command to server if websocket is available
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'command',
                        command: 'stop'
                    }));
                    console.log('Stop command sent to server');
                }
            } catch (error) {
                console.warn('Error sending stop command:', error);
            }

            // Always cleanup resources regardless of websocket state
            await cleanupAudioResources();
            updateUIState(false);
        }

        async function cleanupAudioResources() {
            console.log('Cleaning up audio resources...');
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('Stopped audio track:', track.kind);
                });
                audioStream = null;
            }

            if (audioContext && audioContext.state !== 'closed') {
                try {
                    await audioContext.close();
                    console.log('AudioContext closed successfully');
                } catch (err) {
                    console.error('Error closing AudioContext:', err);
                }
            }
            audioContext = null;
            source = null;
            gainNode = null;
            analyser = null;

            // Close WebSocket if it exists
            if (ws) {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
                ws = null;
            }

            isListening = false;
            console.log('All audio resources cleaned up');
        }

        async function setupWebSocketWithRetry(retryCount = 0) {
            const maxRetries = 3;
            const retryDelay = 1000;

            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }

                const clientId = generateClientId();
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${clientId}`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    wsConnected = true;
                    // Send initial configuration
                    if (audioContext) {
                        ws.send(JSON.stringify({
                            type: 'config',
                            config: {
                                inputSampleRate: audioContext.sampleRate,
                                targetSampleRate: 16000,
                                channels: 1,
                                bufferSize: 512,
                                sensitivity: parseFloat(sensitivity.value),
                                noiseThreshold: parseFloat(noiseThreshold.value)
                            }
                        }));
                    }
                };
                
                ws.onclose = async (event) => {
                    console.log('WebSocket closed:', event.code, event.reason);
                    wsConnected = false;
                    
                    if (isListening && retryCount < maxRetries) {
                        console.log(`Retrying WebSocket connection (${retryCount + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                        await setupWebSocketWithRetry(retryCount + 1);
                    } else if (isListening) {
                        console.log('Max retries reached, stopping audio capture');
                        await stopListening();
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    if (retryCount >= maxRetries) {
                        stopListening();
                    }
                };
                
                ws.onmessage = handleWebSocketMessage;
                
            } catch (error) {
                console.error('Error setting up WebSocket:', error);
                if (retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                    await setupWebSocketWithRetry(retryCount + 1);
                } else {
                    await stopListening();
                    throw error;
                }
            }
        }

        // Add visualization function
        function visualize() {
            if (!analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Float32Array(bufferLength);
            
            function draw() {
                if (!isListening) return;
                
                requestAnimationFrame(draw);
                analyser.getFloatTimeDomainData(dataArray);
                
                // Calculate RMS value
                let rms = 0;
                for (let i = 0; i < bufferLength; i++) {
                    rms += dataArray[i] * dataArray[i];
                }
                rms = Math.sqrt(rms / bufferLength);
                
                // Update volume meter
                const volumePercent = Math.min(100, rms * 400);
                volumeLevel.style.width = volumePercent + '%';
                
                // Update microphone animation
                const micIcon = document.querySelector('.mic-icon');
                if (rms > 0.01) {
                    micIcon.classList.add('mic-active');
                } else {
                    micIcon.classList.remove('mic-active');
                }
            }
            
            draw();
        }

        function handleWebSocketMessage(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'transcription') {
                    const transcriptionText = document.querySelector('.transcription-text');
                    if (transcriptionText) {
                        transcriptionText.textContent = data.text;
                        robotFace.classList.add('listening');
                    }
                } else if (data.type === 'response') {
                    if (response) {
                        response.textContent = data.text;
                        robotFace.classList.remove('listening');
                    }
                } else if (data.type === 'status') {
                    updateStatus(data.message);
                    if (data.message.toLowerCase().includes('listening') || 
                        data.message.toLowerCase().includes('processing')) {
                        robotFace.classList.add('listening');
                    } else {
                        robotFace.classList.remove('listening');
                    }
                }
            } catch (error) {
                console.error('Error handling WebSocket message:', error);
                robotFace.classList.remove('listening');
            }
        }

        function displayError(message) {
            status.textContent = `Error: ${message}`;
            status.style.color = 'red';
            setTimeout(() => {
                status.style.color = '';
            }, 5000);
        }

        function handleCalibrationComplete(message) {
            console.log('Calibration complete:', message);
            // Handle calibration completion logic here
        }

        function updateUIForListening() {
            // Implement the logic to update the UI for listening
            console.log('Updating UI for listening');
        }

        startButton.addEventListener('click', startListening);
        stopButton.addEventListener('click', stopListening);

        // Add event listeners for calibration buttons
        startCalibration.addEventListener('click', () => {
            if (!isListening) {
                startListening();
            }
            calibrationMode = true;
            calibrationSamples = [];
            startCalibration.style.display = 'none';
            stopCalibration.style.display = 'inline';
            calibrationStatus.style.display = 'block';
            progressBar.style.width = '0%';
            samplesCount.textContent = 'Samples: 0/5';
            addLogEntry('Starting calibration mode');
        });

        stopCalibration.addEventListener('click', () => {
            calibrationMode = false;
            startCalibration.style.display = 'inline';
            stopCalibration.style.display = 'none';
            calibrationStatus.style.display = 'none';
            if (!isListening) {
                stopListening();
            }
            addLogEntry('Stopped calibration mode');
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopListening();
            if (ws) {
                ws.close();
            }
        });

        shuffleButton.addEventListener('click', () => {
            currentFaceIndex = (currentFaceIndex + 1) % robotFaces.length;
            robotFace.src = robotFaces[currentFaceIndex];
            // Save the selected avatar to localStorage
            localStorage.setItem('selectedAvatar', robotFaces[currentFaceIndex]);
        });

        // Add event listeners for filters
        showServerLogs.addEventListener('change', updateLogDisplay);
        showClientLogs.addEventListener('change', updateLogDisplay);
        showDebug.addEventListener('change', updateLogDisplay);
        showInfo.addEventListener('change', updateLogDisplay);
        showWarning.addEventListener('change', updateLogDisplay);
        showError.addEventListener('change', updateLogDisplay);

        // Add search functionality
        logSearch.addEventListener('input', updateLogDisplay);

        // Add this to your existing JavaScript
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.container');
            const settingsColumn = document.querySelector('.settings-column');
            const mainColumn = document.querySelector('.main-column');
            const logsColumn = document.querySelector('.logs-column');
            const settingsToggle = document.getElementById('settingsToggle');
            const mainToggle = document.getElementById('mainToggle');
            const logsToggle = document.getElementById('logsToggle');
            const collapsedAvatar = document.getElementById('collapsedAvatar');

            function updateCollapsedAvatar() {
                const currentAvatar = document.getElementById('robotFace').src;
                collapsedAvatar.src = currentAvatar;
            }

            settingsToggle.addEventListener('click', () => {
                settingsColumn.classList.toggle('collapsed');
                container.classList.toggle('settings-collapsed');
            });

            mainToggle.addEventListener('click', () => {
                mainColumn.classList.toggle('collapsed');
                container.classList.toggle('main-collapsed');
                updateCollapsedAvatar();
            });

            logsToggle.addEventListener('click', () => {
                logsColumn.classList.toggle('collapsed');
                container.classList.toggle('logs-collapsed');
            });

            // Update collapsed avatar when robot face changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                        updateCollapsedAvatar();
                    }
                });
            });

            observer.observe(document.getElementById('robotFace'), {
                attributes: true,
                attributeFilter: ['src']
            });

            // Initial avatar update
            updateCollapsedAvatar();
        });

        // Add clear logs functionality
        const clearLogs = document.getElementById('clearLogs');

        clearLogs.addEventListener('click', () => {
            try {
                logEntries = [];
                localStorage.removeItem('voiceLogs');
                logContainer.innerHTML = ''; // Immediately clear the display
                updateLogDisplay();
                addLogEntry('All logs cleared', false, 'client', 'INFO');
            } catch (error) {
                console.error('Error clearing logs:', error);
                addLogEntry('Failed to clear logs: ' + error.message, true, 'client', 'ERROR');
            }
        });

        // Add copy logs functionality
        const copyLogs = document.getElementById('copyLogs');
        const copyFeedback = document.getElementById('copyFeedback');

        copyLogs.addEventListener('click', () => {
            try {
                // Get all visible log entries
                const visibleEntries = logEntries.filter(entry => {
                    // Source filter
                    if (entry.source === 'server' && !showServerLogs.checked) return false;
                    if (entry.source === 'client' && !showClientLogs.checked) return false;

                    // Level filter
                    if (entry.level === 'DEBUG' && !showDebug.checked) return false;
                    if (entry.level === 'INFO' && !showInfo.checked) return false;
                    if (entry.level === 'WARNING' && !showWarning.checked) return false;
                    if (entry.level === 'ERROR' && !showError.checked) return false;

                    // Search filter
                    const searchTerm = logSearch.value.toLowerCase();
                    if (searchTerm && !entry.message.toLowerCase().includes(searchTerm)) return false;

                    return true;
                });

                // Format logs for copying
                const formattedLogs = visibleEntries.map(entry => {
                    const timestamp = formatTimestamp(entry.timestamp);
                    return `[${timestamp}] [${entry.source}] [${entry.level}] ${entry.message}`;
                }).join('\n');

                // Copy to clipboard
                navigator.clipboard.writeText(formattedLogs).then(() => {
                    // Show feedback
                    copyFeedback.style.display = 'block';
                    setTimeout(() => {
                        copyFeedback.style.display = 'none';
                    }, 2000);
                    
                    addLogEntry('Logs copied to clipboard', false, 'client', 'INFO');
                }).catch(err => {
                    console.error('Failed to copy logs:', err);
                    addLogEntry('Failed to copy logs: ' + err.message, true, 'client', 'ERROR');
                });
            } catch (error) {
                console.error('Error copying logs:', error);
                addLogEntry('Failed to copy logs: ' + error.message, true, 'client', 'ERROR');
            }
        });

        // Inspiration data
        const inspirations = [
            {
                text: "Taking a 10-minute walk in nature can significantly improve your mood and reduce stress levels. This phenomenon, known as 'nature therapy' or 'forest bathing', has been shown to lower cortisol levels by up to 16%.",
                source: "Environmental Health and Preventive Medicine",
                link: "https://doi.org/10.1007/s12199-009-0086-9",
                visualization: {
                    type: "bar",
                    labels: ["Before", "After 10min Walk"],
                    values: [100, 84],
                    metric: "Cortisol Levels",
                    unit: "%"
                },
                tags: ["stress-reduction", "exercise", "nature", "mental-health"],
                action: "Start a Nature Walk"
            },
            {
                text: "Practicing gratitude for just 5 minutes daily has been linked to a 10% increase in happiness and a 35% reduction in depressive symptoms over 6 months.",
                source: "Journal of Clinical Psychology",
                link: "https://doi.org/10.1002/jclp.22015",
                visualization: {
                    type: "bar",
                    labels: ["Before", "After 6 Months"],
                    values: [100, 65],
                    metric: "Depressive Symptoms",
                    unit: "%"
                },
                tags: ["mental-health", "happiness", "daily-practice", "mindfulness"],
                action: "Start Gratitude Journal"
            },
            {
                text: "Regular meditation practice of just 8 minutes per day can physically alter brain structure, improving memory, empathy, and stress management within 8 weeks.",
                source: "Psychiatry Research: Neuroimaging",
                link: "https://doi.org/10.1016/j.pscychresns.2010.08.006",
                visualization: {
                    type: "bar",
                    labels: ["Before", "After 8 Weeks"],
                    values: [100, 127],
                    metric: "Gray Matter Density",
                    unit: "%"
                },
                tags: ["meditation", "brain-health", "mindfulness", "daily-practice"],
                action: "Start Meditation"
            },
            {
                text: "Maintaining proper hydration by drinking water regularly throughout the day can improve cognitive performance by up to 14% and boost energy levels significantly.",
                source: "Frontiers in Human Neuroscience",
                link: "https://doi.org/10.3389/fnhum.2013.00363",
                visualization: {
                    type: "bar",
                    labels: ["Dehydrated", "Hydrated"],
                    values: [100, 114],
                    metric: "Cognitive Performance",
                    unit: "%"
                },
                tags: ["hydration", "cognitive-health", "energy", "daily-habit"],
                action: "Track Water Intake"
            }
        ];

        // Add inspiration functionality
        const inspirationJewel = document.getElementById('inspirationJewel');
        const inspirationModal = document.getElementById('inspirationModal');
        const inspirationText = document.getElementById('inspirationText');
        const inspirationSource = document.getElementById('inspirationSource');
        const closeInspiration = document.getElementById('closeInspiration');

        function getRandomInspiration() {
            const index = Math.floor(Math.random() * inspirations.length);
            return inspirations[index];
        }

        function createVisualization(data) {
            if (data.type === "bar") {
                const container = document.createElement('div');
                container.className = 'data-visualization';
                
                const title = document.createElement('div');
                title.textContent = data.metric;
                title.style.textAlign = 'center';
                container.appendChild(title);

                const chart = document.createElement('div');
                chart.className = 'bar-chart';

                data.values.forEach((value, index) => {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `${value}px`;

                    const label = document.createElement('div');
                    label.className = 'bar-label';
                    label.textContent = data.labels[index];

                    const valueLabel = document.createElement('div');
                    valueLabel.className = 'bar-value';
                    valueLabel.textContent = `${value}${data.unit}`;

                    bar.appendChild(label);
                    bar.appendChild(valueLabel);
                    chart.appendChild(bar);
                });

                container.appendChild(chart);
                return container;
            }
            return null;
        }

        function createTags(tags) {
            const container = document.createElement('div');
            container.className = 'tags-container';
            
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.textContent = `#${tag}`;
                container.appendChild(tagElement);
            });

            return container;
        }

        function createActionButton(action) {
            const button = document.createElement('button');
            button.className = 'action-button';
            button.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
                ${action}
            `;
            return button;
        }

        inspirationJewel.addEventListener('click', () => {
            const inspiration = getRandomInspiration();
            inspirationText.textContent = inspiration.text;
            inspirationSource.textContent = inspiration.source;
            inspirationSource.href = inspiration.link;

            // Clear previous content
            const content = document.querySelector('.inspiration-content');
            while (content.children.length > 3) {
                content.removeChild(content.lastChild);
            }

            // Add visualization if available
            if (inspiration.visualization) {
                const viz = createVisualization(inspiration.visualization);
                if (viz) content.appendChild(viz);
            }

            // Add tags
            if (inspiration.tags) {
                content.appendChild(createTags(inspiration.tags));
            }

            // Add action button
            if (inspiration.action) {
                content.appendChild(createActionButton(inspiration.action));
            }

            inspirationModal.classList.add('show');
        });

        closeInspiration.addEventListener('click', () => {
            inspirationModal.classList.remove('show');
        });

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            if (!inspirationModal.contains(event.target) && 
                !inspirationJewel.contains(event.target) && 
                inspirationModal.classList.contains('show')) {
                inspirationModal.classList.remove('show');
            }
        });

        // Add click handlers for tags and action buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tag')) {
                console.log('Tag clicked:', e.target.textContent);
                // TODO: Implement tag filtering or related content
            }
            if (e.target.classList.contains('action-button')) {
                console.log('Action clicked:', e.target.textContent);
                // TODO: Implement action flow with AI assistant
            }
        });

        // Add pet video interaction
        const petVideo = document.getElementById('petVideo');
        const normalVideo = '/static/movies/pet-dog-2-small.mp4';
        const smileVideo = '/static/movies/pet-dog-2-smile-small.mp4';
        let isSmiling = false;

        petVideo.addEventListener('click', () => {
            if (!isSmiling) {
                isSmiling = true;
                petVideo.src = smileVideo;
                petVideo.loop = false; // Disable looping for the smile video
                petVideo.load();
                petVideo.play();
                
                // When the smile video ends, switch back to normal
                petVideo.onended = () => {
                    isSmiling = false;
                    petVideo.src = normalVideo;
                    petVideo.loop = true; // Re-enable looping for the normal video
                    petVideo.load();
                    petVideo.play();
                    petVideo.onended = null; // Remove the event listener
                };
            }
        });
    </script>
</body>
</html>

